angular.module("textAngular.DOM",["textAngular.factories"]).factory("taExecCommand",["taSelection","taBrowserTag","$document",function(e,t,n){var r=function(t,n){var r,a,o=t.find("li");for(a=o.length-1;a>=0;a--)r=angular.element("<"+n+">"+o[a].innerHTML+"</"+n+">"),t.after(r);t.remove(),e.setSelectionToElementEnd(r[0])},a=function(t){/(<br(|\/)>)$/i.test(t.innerHTML.trim())?e.setSelectionBeforeElement(angular.element(t).find("br")[0]):e.setSelectionToElementEnd(t)},o=function(e,t){var n=angular.element("<"+t+">"+e[0].innerHTML+"</"+t+">");e.after(n),e.remove(),a(n.find("li")[0])},i=function(e,n,r){for(var o="",i=0;i<e.length;i++)o+="<"+t("li")+">"+e[i].innerHTML+"</"+t("li")+">";var l=angular.element("<"+r+">"+o+"</"+r+">");n.after(l),n.remove(),a(l.find("li")[0])},l=function(e,t){for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];r.tagName&&r.tagName.match(BLOCKELEMENTS)&&l(r,t)}if(null===e.parentNode)return e;var a=angular.element(t);return a[0].innerHTML=e.innerHTML,e.parentNode.insertBefore(a[0],e),e.parentNode.removeChild(e),a};return function(a,s){return a=t(a),function(d,c,f,g){var u,m,p,N,h,L,C,v,E=angular.element("<"+a+">");try{e.getSelection&&(v=e.getSelection()),C=e.getSelectionElement();var T,S;void 0!==C.tagName&&("div"===C.tagName.toLowerCase()&&/taTextElement.+/.test(C.id)&&v&&v.start&&1===v.start.offset&&1===v.end.offset?(T=C.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,"&#8203;")),/<br\/>/i.test(T)&&(T=T.replace(/<br\/>/i,"&#8203;")),/<span>(<span>)+/i.test(T)&&(T=__.replace(/<span>(<span>)+/i,"<span>")),/<\/span>(<\/span>)+/i.test(T)&&(T=__.replace(/<\/span>(<\/span>)+/i,"</span>")),/<span><\/span>/i.test(T)&&(T=T.replace(/<span><\/span>/i,"")),S="<div>"+T+"</div>",C.innerHTML=S,e.setSelectionToElementEnd(C.childNodes[0]),C=e.getSelectionElement()):"span"===C.tagName.toLowerCase()&&v&&v.start&&1===v.start.offset&&1===v.end.offset?(T=C.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,"&#8203;")),/<br\/>/i.test(T)&&(T=T.replace(/<br\/>/i,"&#8203;")),/<span>(<span>)+/i.test(T)&&(T=__.replace(/<span>(<span>)+/i,"<span>")),/<\/span>(<\/span>)+/i.test(T)&&(T=__.replace(/<\/span>(<\/span>)+/i,"</span>")),/<span><\/span>/i.test(T)&&(T=T.replace(/<span><\/span>/i,"")),S="<div>"+T+"</div>",C.innerHTML=S,e.setSelectionToElementEnd(C.childNodes[0]),C=e.getSelectionElement()):"p"===C.tagName.toLowerCase()&&v&&v.start&&1===v.start.offset&&1===v.end.offset?(T=C.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,"&#8203;")),C.innerHTML=T):"li"===C.tagName.toLowerCase()&&v&&v.start&&v.start.offset===v.end.offset&&(T=C.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,"")),C.innerHTML=T))}catch(M){}var y=angular.element(C),H=C.tagName.toLowerCase();if("insertorderedlist"===d.toLowerCase()||"insertunorderedlist"===d.toLowerCase()){var w=t("insertorderedlist"===d.toLowerCase()?"ol":"ul");if(H===w)return r(y,a);if("li"===H&&y.parent()[0].tagName.toLowerCase()===w&&1===y.parent().children().length)return r(y.parent(),a);if("li"===H&&y.parent()[0].tagName.toLowerCase()!==w&&1===y.parent().children().length)return o(y.parent(),w);if(H.match(BLOCKELEMENTS)&&!y.hasClass("ta-bind")){if("ol"===H||"ul"===H)return o(y,w);var b=!1;return angular.forEach(y.children(),function(e){e.tagName.match(BLOCKELEMENTS)&&(b=!0)}),b?i(y.children(),y,w):i([angular.element("<div>"+C.innerHTML+"</div>")[0]],y,w)}if(H.match(BLOCKELEMENTS)){if(N=e.getOnlySelectedElements(),0===N.length)m=angular.element("<"+w+"><li>"+C.innerHTML+"</li></"+w+">"),y.html(""),y.append(m);else{if(1===N.length&&("ol"===N[0].tagName.toLowerCase()||"ul"===N[0].tagName.toLowerCase()))return N[0].tagName.toLowerCase()===w?r(angular.element(N[0]),a):o(angular.element(N[0]),w);p="";var A=[];for(u=0;u<N.length;u++)if(3!==N[u].nodeType){var O=angular.element(N[u]);if("li"===N[u].tagName.toLowerCase())continue;p+="ol"===N[u].tagName.toLowerCase()||"ul"===N[u].tagName.toLowerCase()?O[0].innerHTML:"span"!==N[u].tagName.toLowerCase()||"ol"!==N[u].childNodes[0].tagName.toLowerCase()&&"ul"!==N[u].childNodes[0].tagName.toLowerCase()?"<"+t("li")+">"+O[0].innerHTML+"</"+t("li")+">":O[0].childNodes[0].innerHTML,A.unshift(O)}m=angular.element("<"+w+">"+p+"</"+w+">"),A.pop().replaceWith(m),angular.forEach(A,function(e){e.remove()})}return void e.setSelectionToElementEnd(m[0])}}else{if("formatblock"===d.toLowerCase()){for(L=f.toLowerCase().replace(/[<>]/gi,""),"default"===L.trim()&&(L=a,f="<"+a+">"),m="li"===H?y.parent():y;!m[0].tagName||!m[0].tagName.match(BLOCKELEMENTS)&&!m.parent().attr("contenteditable");)m=m.parent(),H=(m[0].tagName||"").toLowerCase();if(H===L){N=m.children();var x=!1;for(u=0;u<N.length;u++)x=x||N[u].tagName.match(BLOCKELEMENTS);x?(m.after(N),h=m.next(),m.remove(),m=h):(E.append(m[0].childNodes),m.after(E),m.remove(),m=E)}else if(m.parent()[0].tagName.toLowerCase()!==L||m.parent().hasClass("ta-bind"))if(H.match(LISTELEMENTS))m.wrap(f);else{for(N=e.getOnlySelectedElements(),0===N.length&&(N=[m[0]]),u=0;u<N.length;u++)if(3===N[u].nodeType||!N[u].tagName.match(BLOCKELEMENTS))for(;3===N[u].nodeType||!N[u].tagName||!N[u].tagName.match(BLOCKELEMENTS);)N[u]=N[u].parentNode;if(N=N.filter(function(e,t,n){return n.indexOf(e)===t}),N.length>1&&(N=N.filter(function(e,t,n){return!("div"===e.nodeName.toLowerCase()&&/^taTextElement/.test(e.id))})),angular.element(N[0]).hasClass("ta-bind"))m=angular.element(f),m[0].innerHTML=N[0].innerHTML,N[0].innerHTML=m[0].outerHTML;else if("blockquote"===L){for(p="",u=0;u<N.length;u++)p+=N[u].outerHTML;for(m=angular.element(f),m[0].innerHTML=p,N[0].parentNode.insertBefore(m[0],N[0]),u=N.length-1;u>=0;u--)N[u].parentNode&&N[u].parentNode.removeChild(N[u])}else if("pre"===L&&e.getStateShiftKey()){for(p="",u=0;u<N.length;u++)p+=N[u].outerHTML;for(m=angular.element(f),m[0].innerHTML=p,N[0].parentNode.insertBefore(m[0],N[0]),u=N.length-1;u>=0;u--)N[u].parentNode&&N[u].parentNode.removeChild(N[u])}else for(u=0;u<N.length;u++){var B=l(N[u],f);N[u]===m[0]&&(m=angular.element(B))}}else{var R=m.parent(),K=R.contents();for(u=0;u<K.length;u++)R.parent().hasClass("ta-bind")&&3===K[u].nodeType&&(E=angular.element("<"+a+">"),E[0].innerHTML=K[u].outerHTML,K[u]=E[0]),R.parent()[0].insertBefore(K[u],R[0]);R.remove()}return e.setSelectionToElementEnd(m[0]),void m[0].focus()}if("createlink"===d.toLowerCase()){if("a"===e.getSelectionElement().tagName.toLowerCase())return void(e.getSelectionElement().href=f);var D='<a href="'+f+'" target="'+(g.a.target?g.a.target:"")+'">',$="</a>",_=e.getSelection();if(_.collapsed)e.insertHtml(D+f+$,s);else if(rangy.getSelection().getRangeAt(0).canSurroundContents()){var V=angular.element(D+$)[0];rangy.getSelection().getRangeAt(0).surroundContents(V)}return}if("inserthtml"===d.toLowerCase())return void e.insertHtml(f,s)}try{n[0].execCommand(d,c,f)}catch(M){}}}}]).service("taSelection",["$document","taDOM","$log",function(e,t,n){var r,a=e[0],o=function(e,t){return e.tagName&&e.tagName.match(/^br$/i)&&0===t&&!e.previousSibling?{element:e.parentNode,offset:0}:{element:e,offset:t}},i={getSelection:function(){var e=rangy.getSelection().getRangeAt(0),t=e.commonAncestorContainer,n={start:o(e.startContainer,e.startOffset),end:o(e.endContainer,e.endOffset),collapsed:e.collapsed};return 3===t.nodeType&&("div"===t.parentNode.nodeName.toLowerCase()&&/^taTextElement/.test(t.parentNode.id)||(t=t.parentNode)),"div"===t.nodeName.toLowerCase()&&/^taTextElement/.test(t.id)?(n.end.element=n.start.element=n.container=t.childNodes[n.start.offset],n.start.offset=n.end.offset=0,n.collapsed=!0):t.parentNode===n.start.element||t.parentNode===n.end.element?n.container=t.parentNode:n.container=t,n},updateLeftArrowKey:function(e){var t=rangy.getSelection().getRangeAt(0);if(t&&t.collapsed){var n=i.getFlattenedDom(t);if(!n.findIndex)return;var r,a,o=t.startContainer,l=n.findIndex(function(e,t){if(e.node===o)return!0;var n=e.parents.indexOf(o);return n!==-1});if(n.forEach(function(e,t){e.parents.forEach(function(e,t){})}),l+1<n.length&&(a=n[l+1].node),a&&a.textContent&&(r=/^\ufeff([^\ufeff]*)$/.exec(a.textContent)))return;var s;if(l>0&&(s=n[l-1].node),0===t.startOffset&&s&&(r=/^\ufeff([^\ufeff]*)$/.exec(s.textContent)))return void i.setSelectionToElementEnd(s)}},updateRightArrowKey:function(e){},getFlattenedDom:function(e){function t(e){if(e.node.childNodes.length){var n=Array.prototype.slice.call(e.node.childNodes);n.forEach(function(n){var r=e.parents.slice();r.slice(-1)[0]!==e.node&&r.push(e.node),t({parents:r,node:n})})}else r.push({parents:e.parents,node:e.node})}var n=e.commonAncestorContainer.parentNode;if(!n)return e.commonAncestorContainer.childNodes;var r=Array.prototype.slice.call(n.childNodes),a=r.indexOf(e.startContainer);return a+1<r.length&&a>0||n.parentNode&&(n=n.parentNode),r=[],t({parents:[n],node:n}),r},getOnlySelectedElements:function(){var e=rangy.getSelection().getRangeAt(0),t=e.commonAncestorContainer;return t=3===t.nodeType?t.parentNode:t,e.getNodes([1],function(e){return e.parentNode===t})},getAllSelectedElements:function(){var e=rangy.getSelection().getRangeAt(0),t=e.commonAncestorContainer;t=3===t.nodeType?t.parentNode:t;var n=e.getNodes([1],function(e){return e.parentNode===t}),r=t.innerHTML;if(r=r.replace(/<span id=.selectionBoundary[^>]+>\ufeff?<\/span>/gi,""),r===e.toHtml()&&("div"!==t.nodeName.toLowerCase()||!/^taTextElement/.test(t.id))){for(var a=[],o=n.length;o--;a.unshift(n[o]));n=a,n.push(t)}return n},getSelectionElement:function(){return i.getSelection().container},setSelection:function(e,t,n){var r=rangy.createRange();r.setStart(e,t),r.setEnd(e,n),rangy.getSelection().setSingleRange(r)},setSelectionBeforeElement:function(e){var t=rangy.createRange();t.selectNode(e),t.collapse(!0),rangy.getSelection().setSingleRange(t)},setSelectionAfterElement:function(e){var t=rangy.createRange();t.selectNode(e),t.collapse(!1),rangy.getSelection().setSingleRange(t)},setSelectionToElementStart:function(e){var t=rangy.createRange();t.selectNodeContents(e),t.collapse(!0),rangy.getSelection().setSingleRange(t)},setSelectionToElementEnd:function(e){var t=rangy.createRange();t.selectNodeContents(e),t.collapse(!1),e.childNodes&&e.childNodes[e.childNodes.length-1]&&"br"===e.childNodes[e.childNodes.length-1].nodeName&&(t.startOffset=t.endOffset=t.startOffset-1),rangy.getSelection().setSingleRange(t)},setStateShiftKey:function(e){r=e},getStateShiftKey:function(){return r},insertHtml:function(e,n){var r,o,l,s,d,c,f,g=angular.element("<div>"+e+"</div>"),u=rangy.getSelection().getRangeAt(0),m=a.createDocumentFragment(),p=g[0].childNodes,N=!0;if(p.length>0){for(s=[],l=0;l<p.length;l++){var h=p[l];"p"===h.nodeName.toLowerCase()&&""===h.innerHTML.trim()||(3!==h.nodeType||h.nodeValue!=="\ufeff"[0]||""!==h.nodeValue.trim()?3===h.nodeType&&""===h.nodeValue.trim()||(N=N&&!BLOCKELEMENTS.test(h.nodeName),s.push(h)):s.push(h))}for(var L=0;L<s.length;L++)c=m.appendChild(s[L]);!N&&u.collapsed&&/^(|<br(|\/)>)$/i.test(u.startContainer.innerHTML)&&u.selectNode(u.startContainer)}else N=!0,c=m=a.createTextNode(e);if(N)u.deleteContents();else if(u.collapsed&&u.startContainer!==n)if(u.startContainer.innerHTML&&u.startContainer.innerHTML.match(/^<[^>]*>$/i))r=u.startContainer,1===u.startOffset?(u.setStartAfter(r),u.setEndAfter(r)):(u.setStartBefore(r),u.setEndBefore(r));else{if(3===u.startContainer.nodeType&&u.startContainer.parentNode!==n)for(r=u.startContainer.parentNode,o=r.cloneNode(),t.splitNodes(r.childNodes,r,o,u.startContainer,u.startOffset);!VALIDELEMENTS.test(r.nodeName);){angular.element(r).after(o),r=r.parentNode;var C=o;o=r.cloneNode(),t.splitNodes(r.childNodes,r,o,C)}else r=u.startContainer,o=r.cloneNode(),t.splitNodes(r.childNodes,r,o,void 0,void 0,u.startOffset);if(angular.element(r).after(o),u.setStartAfter(r),u.setEndAfter(r),/^(|<br(|\/)>)$/i.test(r.innerHTML.trim())&&(u.setStartBefore(r),u.setEndBefore(r),angular.element(r).remove()),/^(|<br(|\/)>)$/i.test(o.innerHTML.trim())&&angular.element(o).remove(),"li"===r.nodeName.toLowerCase()){for(f=a.createDocumentFragment(),d=0;d<m.childNodes.length;d++)g=angular.element("<li>"),t.transferChildNodes(m.childNodes[d],g[0]),t.transferNodeAttributes(m.childNodes[d],g[0]),f.appendChild(g[0]);m=f,c&&(c=m.childNodes[m.childNodes.length-1],c=c.childNodes[c.childNodes.length-1])}}else u.deleteContents();u.insertNode(m),c&&i.setSelectionToElementEnd(c)}};return i}]).service("taDOM",function(){var e={getByAttribute:function(t,n){var r=[],a=t.children();return a.length&&angular.forEach(a,function(t){r=r.concat(e.getByAttribute(angular.element(t),n))}),void 0!==t.attr(n)&&r.push(t),r},transferChildNodes:function(e,t){for(t.innerHTML="";e.childNodes.length>0;)t.appendChild(e.childNodes[0]);return t},splitNodes:function(t,n,r,a,o,i){if(!a&&isNaN(i))throw new Error("taDOM.splitNodes requires a splitNode or splitIndex");for(var l=document.createDocumentFragment(),s=document.createDocumentFragment(),d=0;t.length>0&&(isNaN(i)||i!==d)&&t[0]!==a;)l.appendChild(t[0]),d++;for(!isNaN(o)&&o>=0&&t[0]&&(l.appendChild(document.createTextNode(t[0].nodeValue.substring(0,o))),t[0].nodeValue=t[0].nodeValue.substring(o));t.length>0;)s.appendChild(t[0]);e.transferChildNodes(l,n),e.transferChildNodes(s,r)},transferNodeAttributes:function(e,t){for(var n=0;n<e.attributes.length;n++)t.setAttribute(e.attributes[n].name,e.attributes[n].value);return t}};return e});